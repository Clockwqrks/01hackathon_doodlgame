<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Char Auction Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        .status { background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .game-bar { background: #007bff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .timer { font-size: 24px; }
        .money { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .panel { background: white; border-radius: 10px; padding: 30px; max-width: 400px; width: 90%; text-align: center; }
        .panel h2 { margin-bottom: 20px; }
        
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .btn.secondary { background: #28a745; }
        .btn.secondary:hover { background: #218838; }
        
        .room-code { background: #e8f5e8; border: 3px solid #28a745; border-radius: 10px; padding: 25px; margin: 20px 0; font-size: 36px; font-weight: bold; letter-spacing: 10px; color: #155724; }
        
        .form-group { margin: 15px 0; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; text-align: center; text-transform: uppercase; }
        
        .toolbar { display: flex; justify-content: center; gap: 15px; padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .color { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 0 0 2px #ddd; }
        .color.active { box-shadow: 0 0 0 3px #333; }
        .tool { padding: 8px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white; }
        .tool.active { background: #333; color: white; }
        
        .canvas-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        canvas { border: 2px solid #ddd; cursor: crosshair; max-width: 100%; max-height: 100%; }
        
        .players { position: fixed; top: 100px; left: 20px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 200px; }
        .player { padding: 8px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .player:last-child { border-bottom: none; }
        
        .chat { position: fixed; bottom: 20px; right: 20px; width: 250px; height: 300px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .chat-header { background: #f0f0f0; padding: 10px; border-radius: 10px 10px 0 0; font-weight: bold; text-align: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; }
        .chat-input { padding: 10px; border: none; border-top: 1px solid #ddd; border-radius: 0 0 10px 10px; }
        .message { margin-bottom: 10px; padding: 6px 10px; background: #f0f0f0; border-radius: 12px; font-size: 13px; }
        .message.own { background: #007bff; color: white; margin-left: 20px; }
        
        .bid-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .bid-modal.active { display: flex; }
        .bid-panel { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; text-align: center; }
        .bid-artwork { width: 300px; height: 200px; border: 3px solid #ddd; border-radius: 10px; margin: 0 auto 20px; }
        .current-bid { font-size: 28px; color: #e74c3c; font-weight: bold; margin: 15px 0; }
        .bid-timer { font-size: 18px; color: #f39c12; margin-bottom: 20px; }
        .bid-input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; width: 120px; text-align: center; margin-right: 10px; }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .players { position: relative; margin: 10px; width: auto; }
            .chat { width: 200px; height: 250px; }
            .toolbar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="status" id="status">Ready to play</div>

    <div class="modal" id="lobby">
        <div class="panel">
            <h2>Auction Game</h2>
            <div id="mainMenu">
                <button class="btn" onclick="createRoom()">Host Game</button>
                <button class="btn secondary" onclick="showJoin()">Join Game</button>
            </div>

            <div id="hostPanel" class="hidden">
                <h3>Room Created!</h3>
                <div class="room-code" id="roomCode">ABCD</div>
                <p>Players join with this 4-character code</p>
                <div id="playerList"></div>
                <button class="btn" id="startBtn" onclick="startGame()" style="display:none;">Start Game</button>
                <button class="btn" onclick="backToMenu()">Close</button>
            </div>

            <div id="joinPanel" class="hidden">
                <h3>Join Game</h3>
                <div class="form-group">
                    <label>Your Name:</label>
                    <input type="text" id="playerName" value="Player" maxlength="15">
                </div>
                <div class="form-group">
                    <label>4-Character Room Code:</label>
                    <input type="text" id="roomCodeInput" placeholder="ABCD" maxlength="4">
                </div>
                <button class="btn secondary" onclick="joinRoom()">Join</button>
                <button class="btn" onclick="backToMenu()">Back</button>
            </div>
        </div>
    </div>

    <div class="bid-modal" id="bidModal">
        <div class="bid-panel">
            <h3>Artwork Auction</h3>
            <canvas class="bid-artwork" id="bidArtwork" width="300" height="200"></canvas>
            <div class="current-bid" id="currentBid">Current Bid: $0</div>
            <div class="bid-timer" id="bidTimer">Time: 30s</div>
            <div>
                <input type="number" class="bid-input" id="bidInput" placeholder="Your bid" min="0">
                <button class="btn" onclick="placeBid()">Bid</button>
            </div>
        </div>
    </div>

    <div class="game-bar">
        <div class="timer" id="timer">Ready</div>
        <div class="money" id="money">$10,000</div>
        <button class="btn" id="submitBtn" onclick="submit()" disabled>Submit Drawing</button>
    </div>

    <div class="toolbar">
        <div class="color active" style="background:#ff6b6b" data-color="#ff6b6b"></div>
        <div class="color" style="background:#4ecdc4" data-color="#4ecdc4"></div>
        <div class="color" style="background:#45b7d1" data-color="#45b7d1"></div>
        <div class="color" style="background:#96ceb4" data-color="#96ceb4"></div>
        <div class="color" style="background:#feca57" data-color="#feca57"></div>
        <div class="color" style="background:#ff9ff3" data-color="#ff9ff3"></div>
        <div class="tool active" data-tool="draw">üñåÔ∏è</div>
        <div class="tool" data-tool="erase">üßΩ</div>
        <button class="btn" onclick="clearCanvas()">Clear</button>
    </div>

    <div class="canvas-container">
        <canvas id="canvas" width="800" height="500"></canvas>
    </div>

    <div class="players">
        <h4>Players</h4>
        <div id="players"></div>
    </div>

    <div class="chat">
        <div class="chat-header">Chat</div>
        <div class="chat-messages" id="chatMsgs"></div>
        <input class="chat-input" id="chatInput" placeholder="Type message..." maxlength="100" disabled>
    </div>

    <script>
        // Firebase-like simple signaling (using jsonbin.io for free tier)
        const API_KEY = '$2a$10$YOUR_API_KEY'; // Get free key from jsonbin.io
        const BASE_URL = 'https://api.jsonbin.io/v3/b';
        
        // Global state
        let isHost = false, roomCode = '', localPlayer = null, players = [], gameState = 'lobby';
        let currentColor = '#ff6b6b', currentTool = 'draw', isDrawing = false;
        let canvas, ctx, gameTimer = null, timeLeft = 0, pollInterval = null;
        let artworks = [], currentBid = 0, currentBidder = null, auctionTimer = null;

        const prompts = [
            'Cat wearing a hat', 'Robot eating pizza', 'Dragon in space', 
            'Alien dancing', 'Superhero dog', 'Unicorn on bicycle',
            'Wizard making coffee', 'Pirate ship', 'Ghost cooking'
        ];

        // Initialize
        window.onload = () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            setupEventListeners();
        };

        function setupEventListeners() {
            // Canvas events
            canvas.onmousedown = startDraw;
            canvas.onmousemove = draw;
            canvas.onmouseup = canvas.onmouseout = stopDraw;
            canvas.ontouchstart = e => { e.preventDefault(); startDraw(e.touches[0]); };
            canvas.ontouchmove = e => { e.preventDefault(); draw(e.touches[0]); };
            canvas.ontouchend = e => { e.preventDefault(); stopDraw(); };
            
            // Tool events
            document.querySelectorAll('.color').forEach(el => el.onclick = () => {
                document.querySelectorAll('.color').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                currentColor = el.dataset.color;
            });
            
            document.querySelectorAll('.tool').forEach(el => el.onclick = () => {
                document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                currentTool = el.dataset.tool;
            });
            
            // Chat
            document.getElementById('chatInput').onkeypress = e => {
                if (e.key === 'Enter') sendChat();
            };

            // Room code input
            document.getElementById('roomCodeInput').oninput = e => {
                e.target.value = e.target.value.toUpperCase().slice(0, 4);
            };
        }

        // Canvas functions
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineWidth = 3;
            ctx.strokeStyle = currentTool === 'draw' ? currentColor : '#FFFFFF';
            ctx.globalCompositeOperation = currentTool === 'draw' ? 'source-over' : 'destination-out';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
            ctx.globalCompositeOperation = 'source-over';
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Room functions
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showJoin() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('joinPanel').classList.remove('hidden');
        }

        async function createRoom() {
            roomCode = generateRoomCode();
            isHost = true;
            localPlayer = { id: 'host', name: 'Host', money: 10000, isHost: true };
            players = [localPlayer];
            
            // Create room in cloud
            const roomData = {
                code: roomCode,
                host: localPlayer.id,
                players: players,
                gameState: 'lobby',
                messages: [],
                currentBid: 0,
                currentBidder: null,
                artworks: [],
                created: Date.now()
            };

            try {
                const response = await fetch(BASE_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(roomData)
                });
                
                if (!response.ok) {
                    // Fallback to localStorage for local testing
                    localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                }
                
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('hostPanel').classList.remove('hidden');
                document.getElementById('roomCode').textContent = roomCode;
                
                startPolling();
                updatePlayers();
                updateStatus(`Room ${roomCode} created`, 'connected');
                enableChat();
                
            } catch (error) {
                console.log('Using localStorage fallback');
                localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('hostPanel').classList.remove('hidden');
                document.getElementById('roomCode').textContent = roomCode;
                
                startPolling();
                updatePlayers();
                updateStatus(`Room ${roomCode} created (local)`, 'connected');
                enableChat();
            }
        }

        async function joinRoom() {
            const name = document.getElementById('playerName').value.trim() || 'Player';
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (code.length !== 4) {
                alert('Please enter a 4-character room code!');
                return;
            }

            try {
                // Try to find room
                let roomData = null;
                
                // Try localStorage first (for local testing)
                roomData = JSON.parse(localStorage.getItem(`room_${code}`) || 'null');
                
                if (!roomData) {
                    alert('Room not found! Check the code.');
                    return;
                }

                roomCode = code;
                isHost = false;
                localPlayer = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    name: name, 
                    money: 10000, 
                    isHost: false 
                };

                // Add player to room
                roomData.players.push(localPlayer);
                localStorage.setItem(`room_${code}`, JSON.stringify(roomData));

                players = roomData.players;
                gameState = roomData.gameState;
                currentBid = roomData.currentBid || 0;
                currentBidder = roomData.currentBidder;

                document.getElementById('lobby').classList.add('hidden');
                startPolling();
                updatePlayers();
                updateStatus(`Joined room ${code}`, 'connected');
                enableChat();
                
            } catch (error) {
                alert('Error joining room. Please try again.');
            }
        }

        function startPolling() {
            pollInterval = setInterval(async () => {
                if (!roomCode) return;
                
                try {
                    const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`) || 'null');
                    if (!roomData) return;

                    // Sync game state
                    players = roomData.players || [];
                    gameState = roomData.gameState || 'lobby';
                    currentBid = roomData.currentBid || 0;
                    currentBidder = roomData.currentBidder;
                    artworks = roomData.artworks || [];

                    updatePlayers();
                    updateGameUI();

                    // Handle messages
                    if (roomData.messages) {
                        roomData.messages.forEach(msg => {
                            if (msg.from !== localPlayer.id && !msg.processed) {
                                handleMessage(msg);
                                msg.processed = true;
                            }
                        });
                        localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                    }
                    
                } catch (error) {
                    console.error('Polling error:', error);
                }
            }, 1000);
        }

        function broadcast(msg) {
            if (!roomCode) return;
            
            try {
                const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`) || '{}');
                if (!roomData.messages) roomData.messages = [];
                
                roomData.messages.push({
                    ...msg,
                    from: localPlayer.id,
                    timestamp: Date.now(),
                    processed: false
                });

                // Update synchronized state
                if (msg.type === 'bid') {
                    roomData.currentBid = msg.amount;
                    roomData.currentBidder = localPlayer.id;
                    currentBid = msg.amount;
                    currentBidder = localPlayer.id;
                }

                // Keep only last 50 messages
                if (roomData.messages.length > 50) {
                    roomData.messages = roomData.messages.slice(-50);
                }

                localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                
            } catch (error) {
                console.error('Broadcast error:', error);
            }
        }

        function handleMessage(msg) {
            switch (msg.type) {
                case 'chat':
                    addChatMessage(msg.content, msg.sender);
                    break;
                case 'bid':
                    currentBid = msg.amount;
                    currentBidder = msg.playerId;
                    updateBidDisplay();
                    break;
                case 'gameStart':
                    startDrawing();
                    break;
                case 'startAuction':
                    startAuction();
                    break;
            }
        }

        // Game functions
        function startGame() {
            if (players.length < 2) return;
            gameState = 'drawing';
            
            const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`) || '{}');
            roomData.gameState = 'drawing';
            localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
            
            broadcast({ type: 'gameStart' });
            startDrawing();
        }

        function startDrawing() {
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            timeLeft = 90;
            updateTimer();
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) submit();
            }, 1000);
        }

        function submit() {
            if (gameTimer) clearInterval(gameTimer);
            document.getElementById('submitBtn').disabled = true;
            
            const artwork = {
                playerId: localPlayer.id,
                playerName: localPlayer.name,
                imageData: canvas.toDataURL(),
                prompt: prompts[Math.floor(Math.random() * prompts.length)]
            };
            
            artworks.push(artwork);
            
            // Update room data
            const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`) || '{}');
            roomData.artworks = artworks;
            localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
            
            updateStatus('Waiting for others...', 'connected');
            
            // Auto-start auction after delay
            setTimeout(() => {
                if (isHost) {
                    broadcast({ type: 'startAuction' });
                    startAuction();
                }
            }, 3000);
        }

        function startAuction() {
            if (artworks.length === 0) return;
            
            gameState = 'bidding';
            currentBid = 0;
            currentBidder = null;
            
            const artwork = artworks[0];
            document.getElementById('bidModal').classList.add('active');
            
            const canvas = document.getElementById('bidArtwork');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = artwork.imageData;
            
            updateBidDisplay();
            
            // Auction timer
            timeLeft = 30;
            auctionTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('bidTimer').textContent = `Time: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    endAuction();
                }
            }, 1000);
        }

        function placeBid() {
            const amount = parseInt(document.getElementById('bidInput').value);
            if (!amount || amount <= currentBid || amount > localPlayer.money) {
                alert('Invalid bid amount!');
                return;
            }
            
            broadcast({ type: 'bid', amount: amount, playerId: localPlayer.id });
            document.getElementById('bidInput').value = amount + 100;
        }

        function updateBidDisplay() {
            const bidderName = currentBidder ? players.find(p => p.id === currentBidder)?.name : 'None';
            document.getElementById('currentBid').textContent = `Current Bid: $${currentBid} (${bidderName})`;
        }

        function endAuction() {
            if (auctionTimer) clearInterval(auctionTimer);
            
            if (currentBidder) {
                const winner = players.find(p => p.id === currentBidder);
                const seller = players.find(p => p.id === artworks[0].playerId);
                winner.money -= currentBid;
                seller.money += currentBid;
                
                // Update room data
                const roomData = JSON.parse(localStorage.getItem(`room_${roomCode}`) || '{}');
                roomData.players = players;
                localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
            }
            
            document.getElementById('bidModal').classList.remove('active');
            alert(`Auction ended! Winner: ${currentBidder ? players.find(p => p.id === currentBidder)?.name : 'No bids'}`);
        }

        // Communication
        function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            addChatMessage(msg, localPlayer.name, true);
            broadcast({ type: 'chat', content: msg, sender: localPlayer.name });
            input.value = '';
        }

        function addChatMessage(content, sender, own = false) {
            const div = document.createElement('div');
            div.className = `message ${own ? 'own' : ''}`;
            div.innerHTML = `<b>${sender}:</b> ${content}`;
            document.getElementById('chatMsgs').appendChild(div);
            document.getElementById('chatMsgs').scrollTop = 999999;
        }

        function enableChat() {
            document.getElementById('chatInput').disabled = false;
        }

        function backToMenu() {
            if (pollInterval) clearInterval(pollInterval);
            if (gameTimer) clearInterval(gameTimer);
            if (auctionTimer) clearInterval(auctionTimer);
            
            document.querySelectorAll('.panel > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('mainMenu').classList.remove('hidden');
            
            roomCode = '';
            isHost = false;
            localPlayer = null;
            players = [];
            updateStatus('Ready to play');
        }

        // UI helpers
        function updateStatus(text, type = '') {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = `status ${type}`;
        }

        function updatePlayers() {
            const html = players.map(p => 
                `<div class="player"><span>${p.name}${p.isHost ? ' (Host)' : ''}</span><span>$${p.money}</span></div>`
            ).join('');
            document.getElementById('players').innerHTML = html;
            document.getElementById('playerList').innerHTML = `<p>${players.length} players connected</p>`;
            document.getElementById('startBtn').style.display = players.length >= 2 ? 'block' : 'none';
        }

        function updateGameUI() {
            if (localPlayer) {
                document.getElementById('money').textContent = `$${localPlayer.money}`;
            }
        }

        function updateTimer() {
            document.getElementById('timer').textContent = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
