<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>4-Char Auction Game</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        .status { background: #f0f0f0; padding: 10px; text-align: center; font-weight: bold; }
        .status.connected { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        
        .game-bar { background: #007bff; color: white; padding: 10px 20px; display: flex; justify-content: space-between; align-items: center; }
        .timer { font-size: 24px; }
        .money { background: rgba(255,255,255,0.2); padding: 5px 15px; border-radius: 15px; }
        
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        .panel { background: white; border-radius: 10px; padding: 30px; max-width: 500px; width: 90%; text-align: center; max-height: 80vh; overflow-y: auto; }
        .panel h2 { margin-bottom: 20px; }
        
        .btn { background: #007bff; color: white; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; margin: 10px 5px; font-size: 16px; }
        .btn:hover { background: #0056b3; }
        .btn.secondary { background: #28a745; }
        .btn.secondary:hover { background: #218838; }
        
        .room-code { background: #e8f5e8; border: 3px solid #28a745; border-radius: 10px; padding: 25px; margin: 20px 0; font-size: 36px; font-weight: bold; letter-spacing: 10px; color: #155724; }
        
        .form-group { margin: 15px 0; text-align: left; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        .form-group input.room-input { text-align: center; text-transform: uppercase; font-size: 20px; letter-spacing: 4px; }
        
        .setup-panel { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 20px; margin: 20px 0; }
        .setup-panel h4 { color: #856404; margin-bottom: 10px; }
        .setup-panel p { color: #856404; font-size: 14px; line-height: 1.4; }
        .setup-panel a { color: #856404; text-decoration: underline; }
        
        .toolbar { display: flex; justify-content: center; gap: 15px; padding: 15px; background: #f5f5f5; border-bottom: 1px solid #ddd; flex-wrap: wrap; }
        .color { width: 30px; height: 30px; border-radius: 50%; border: 2px solid #fff; cursor: pointer; box-shadow: 0 0 0 2px #ddd; }
        .color.active { box-shadow: 0 0 0 3px #333; }
        .tool { padding: 8px; border: 2px solid #ddd; border-radius: 5px; cursor: pointer; background: white; }
        .tool.active { background: #333; color: white; }
        
        .canvas-container { flex: 1; display: flex; justify-content: center; align-items: center; padding: 20px; }
        canvas { border: 2px solid #ddd; cursor: crosshair; max-width: 100%; max-height: 100%; }
        
        .players { position: fixed; top: 100px; left: 20px; background: white; border-radius: 10px; padding: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); min-width: 200px; }
        .player { padding: 8px 0; display: flex; justify-content: space-between; border-bottom: 1px solid #eee; }
        .player:last-child { border-bottom: none; }
        
        .chat { position: fixed; bottom: 20px; right: 20px; width: 250px; height: 300px; background: white; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); display: flex; flex-direction: column; }
        .chat-header { background: #f0f0f0; padding: 10px; border-radius: 10px 10px 0 0; font-weight: bold; text-align: center; }
        .chat-messages { flex: 1; padding: 10px; overflow-y: auto; }
        .chat-input { padding: 10px; border: none; border-top: 1px solid #ddd; border-radius: 0 0 10px 10px; }
        .message { margin-bottom: 10px; padding: 6px 10px; background: #f0f0f0; border-radius: 12px; font-size: 13px; }
        .message.own { background: #007bff; color: white; margin-left: 20px; }
        
        .bid-modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .bid-modal.active { display: flex; }
        .bid-panel { background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 90%; text-align: center; }
        .bid-artwork { width: 300px; height: 200px; border: 3px solid #ddd; border-radius: 10px; margin: 0 auto 20px; }
        .current-bid { font-size: 28px; color: #e74c3c; font-weight: bold; margin: 15px 0; }
        .bid-timer { font-size: 18px; color: #f39c12; margin-bottom: 20px; }
        .bid-input { padding: 10px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; width: 120px; text-align: center; margin-right: 10px; }
        
        .hidden { display: none; }
        
        @media (max-width: 768px) {
            .players { position: relative; margin: 10px; width: auto; }
            .chat { width: 200px; height: 250px; }
            .toolbar { flex-direction: column; }
        }
    </style>
</head>
<body>
    <div class="status" id="status">Ready to play</div>

    <div class="modal" id="lobby">
        <div class="panel">
            <h2>Auction Game</h2>
            
            
            <div id="mainMenu">
                <button class="btn" onclick="createRoom()">Host Game</button>
                <button class="btn secondary" onclick="showJoin()">Join Game</button>
            </div>

            <div id="hostPanel" class="hidden">
                <h3>Room Created!</h3>
                <div class="room-code" id="roomCode">ABCD</div>
                <p>Players join with this 4-character code</p>
                <div id="playerList"></div>
                <button class="btn" id="startBtn" onclick="startGame()" style="display:none;">Start Game</button>
                <button class="btn" onclick="backToMenu()">Close</button>
            </div>

            <div id="joinPanel" class="hidden">
                <h3>Join Game</h3>
                <div class="form-group">
                    <label>Your Name:</label>
                    <input type="text" id="playerName" value="Player" maxlength="15">
                </div>
                <div class="form-group">
                    <label>4-Character Room Code:</label>
                    <input type="text" id="roomCodeInput" class="room-input" placeholder="ABCD" maxlength="4">
                </div>
                <button class="btn secondary" onclick="joinRoom()">Join</button>
                <button class="btn" onclick="backToMenu()">Back</button>
            </div>
        </div>
    </div>

    <div class="bid-modal" id="bidModal">
        <div class="bid-panel">
            <h3>Artwork Auction</h3>
            <canvas class="bid-artwork" id="bidArtwork" width="300" height="200"></canvas>
            <div class="current-bid" id="currentBid">Current Bid: $0</div>
            <div class="bid-timer" id="bidTimer">Time: 30s</div>
            <div>
                <input type="number" class="bid-input" id="bidInput" placeholder="Your bid" min="0">
                <button class="btn" onclick="placeBid()">Bid</button>
            </div>
        </div>
    </div>

    <div class="game-bar">
        <div class="timer" id="timer">Ready</div>
        <div class="money" id="money">$10,000</div>
        <button class="btn" id="submitBtn" onclick="submit()" disabled>Submit Drawing</button>
    </div>

    <div class="toolbar">
        <div class="color active" style="background:#ff6b6b" data-color="#ff6b6b"></div>
        <div class="color" style="background:#4ecdc4" data-color="#4ecdc4"></div>
        <div class="color" style="background:#45b7d1" data-color="#45b7d1"></div>
        <div class="color" style="background:#96ceb4" data-color="#96ceb4"></div>
        <div class="color" style="background:#feca57" data-color="#feca57"></div>
        <div class="color" style="background:#ff9ff3" data-color="#ff9ff3"></div>
        <div class="tool active" data-tool="draw">üñåÔ∏è</div>
        <div class="tool" data-tool="erase">üßΩ</div>
        <button class="btn" onclick="clearCanvas()">Clear</button>
    </div>

    <div class="canvas-container">
        <canvas id="canvas" width="800" height="500"></canvas>
    </div>

    <div class="players">
        <h4>Players</h4>
        <div id="players"></div>
    </div>

    <div class="chat">
        <div class="chat-header">Chat</div>
        <div class="chat-messages" id="chatMsgs"></div>
        <input class="chat-input" id="chatInput" placeholder="Type message..." maxlength="100" disabled>
    </div>

    <script>
        // JSONBin.io Configuration - REPLACE WITH CORRECT API KEY
        const API_KEY = '$2a$10$8Wd8mIV2W.RK9bceV7gYlO7vm3o39WnJhyG08b.mnw6qN7wqqYtAS'; // Get from jsonbin.io dashboard -> API Keys
        const BASE_URL = 'https://api.jsonbin.io/v3/b';
        const USE_LOCAL_STORAGE = false; // Set to true for local testing
        
        // Global state
        let isHost = false, roomCode = '', localPlayer = null, players = [], gameState = 'lobby';
        let currentColor = '#ff6b6b', currentTool = 'draw', isDrawing = false;
        let canvas, ctx, gameTimer = null, timeLeft = 0, pollInterval = null;
        let artworks = [], currentBid = 0, currentBidder = null, auctionTimer = null;
        let roomBinId = null, lastMessageCount = 0, processedMessages = new Set();

        const prompts = [
            'Cat wearing a hat', 'Robot eating pizza', 'Dragon in space', 
            'Alien dancing', 'Superhero dog', 'Unicorn on bicycle',
            'Wizard making coffee', 'Pirate ship', 'Ghost cooking'
        ];

        // Initialize
        window.onload = () => {
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            setupEventListeners();
        };

        function setupEventListeners() {
            // Canvas events
            canvas.onmousedown = startDraw;
            canvas.onmousemove = draw;
            canvas.onmouseup = canvas.onmouseout = stopDraw;
            canvas.ontouchstart = e => { e.preventDefault(); startDraw(e.touches[0]); };
            canvas.ontouchmove = e => { e.preventDefault(); draw(e.touches[0]); };
            canvas.ontouchend = e => { e.preventDefault(); stopDraw(); };
            
            // Tool events
            document.querySelectorAll('.color').forEach(el => el.onclick = () => {
                document.querySelectorAll('.color').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                currentColor = el.dataset.color;
            });
            
            document.querySelectorAll('.tool').forEach(el => el.onclick = () => {
                document.querySelectorAll('.tool').forEach(t => t.classList.remove('active'));
                el.classList.add('active');
                currentTool = el.dataset.tool;
            });
            
            // Chat
            document.getElementById('chatInput').onkeypress = e => {
                if (e.key === 'Enter') sendChat();
            };

            // Room code input
            document.getElementById('roomCodeInput').oninput = e => {
                e.target.value = e.target.value.toUpperCase().slice(0, 4);
            };
        }

        // Canvas functions
        function getPos(e) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: (e.clientX - rect.left) * (canvas.width / rect.width),
                y: (e.clientY - rect.top) * (canvas.height / rect.height)
            };
        }

        function startDraw(e) {
            isDrawing = true;
            const pos = getPos(e);
            ctx.beginPath();
            ctx.moveTo(pos.x, pos.y);
        }

        function draw(e) {
            if (!isDrawing) return;
            const pos = getPos(e);
            ctx.lineWidth = 4;
            ctx.strokeStyle = currentTool === 'draw' ? currentColor : '#FFFFFF';
            ctx.globalCompositeOperation = currentTool === 'draw' ? 'source-over' : 'destination-out';
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDraw() {
            isDrawing = false;
            ctx.globalCompositeOperation = 'source-over';
        }

        function clearCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        // Room functions
        function generateRoomCode() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let result = '';
            for (let i = 0; i < 4; i++) {
                result += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return result;
        }

        function showJoin() {
            document.getElementById('mainMenu').classList.add('hidden');
            document.getElementById('joinPanel').classList.remove('hidden');
        }

        async function createRoom() {
            roomCode = generateRoomCode();
            isHost = true;
            localPlayer = { id: 'host', name: 'Host', money: 10000, isHost: true };
            players = [localPlayer];
            
            const roomData = {
                code: roomCode,
                players: players,
                gameState: 'lobby',
                currentBid: 0,
                currentBidder: null,
                artworks: [],
                messages: [],
                created: Date.now()
            };

            if (USE_LOCAL_STORAGE) {
                // Use localStorage for local testing
                localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                roomBinId = `local_${roomCode}`;
                
                console.log('Room created locally:', roomCode);
                
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('hostPanel').classList.remove('hidden');
                document.getElementById('roomCode').textContent = roomCode;
                
                startPolling();
                updatePlayers();
                updateStatus(`Room ${roomCode} created (local)`, 'connected');
                enableChat();
                return;
            }

            try {
                // Try JSONBin.io API
                const response = await fetch(`${BASE_URL}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY,
                        'X-Bin-Name': `room_${roomCode}`
                    },
                    body: JSON.stringify(roomData)
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const result = await response.json();
                roomBinId = result.metadata.id;
                
                console.log('Room created successfully:', roomCode, 'Bin ID:', roomBinId);
                
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('hostPanel').classList.remove('hidden');
                document.getElementById('roomCode').textContent = roomCode;
                
                startPolling();
                updatePlayers();
                updateStatus(`Room ${roomCode} created`, 'connected');
                enableChat();
                
            } catch (error) {
                console.error('Error creating room:', error);
                updateStatus('API failed - using local mode', 'error');
                
                // Fallback to localStorage
                localStorage.setItem(`room_${roomCode}`, JSON.stringify(roomData));
                roomBinId = `local_${roomCode}`;
                
                document.getElementById('mainMenu').classList.add('hidden');
                document.getElementById('hostPanel').classList.remove('hidden');
                document.getElementById('roomCode').textContent = roomCode;
                
                startPolling();
                updatePlayers();
                updateStatus(`Room ${roomCode} created (local fallback)`, 'connected');
                enableChat();
            }
        }

        async function storeRoomMapping(roomCode, binId) {
            try {
                let mappings = {};
                
                // Try to get existing mappings
                try {
                    const response = await fetch(`${BASE_URL}/ROOM_MAPPINGS`, {
                        headers: { 'X-Master-Key': API_KEY }
                    });
                    if (response.ok) {
                        const data = await response.json();
                        mappings = data.record || {};
                    }
                } catch (e) {
                    // Will create new mappings bin
                }

                mappings[roomCode] = binId;

                await fetch(`${BASE_URL}/ROOM_MAPPINGS`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(mappings)
                });
                
            } catch (error) {
                console.error('Error storing room mapping:', error);
            }
        }

        async function joinRoom() {
            const name = document.getElementById('playerName').value.trim() || 'Player';
            const code = document.getElementById('roomCodeInput').value.trim().toUpperCase();
            
            if (code.length !== 4) {
                alert('Please enter a 4-character room code!');
                return;
            }

            if (USE_LOCAL_STORAGE) {
                // Use localStorage for local testing
                const roomData = JSON.parse(localStorage.getItem(`room_${code}`) || 'null');
                if (!roomData) {
                    alert('Room not found! Make sure you\'re on the same device as the host.');
                    return;
                }

                roomCode = code;
                roomBinId = `local_${code}`;
                isHost = false;
                localPlayer = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    name: name, 
                    money: 10000, 
                    isHost: false 
                };

                roomData.players.push(localPlayer);
                localStorage.setItem(`room_${code}`, JSON.stringify(roomData));

                document.getElementById('lobby').classList.add('hidden');
                startPolling();
                updateStatus(`Joined room ${code} (local)`, 'connected');
                enableChat();
                return;
            }

            try {
                // Try JSONBin.io API
                const searchResponse = await fetch(`${BASE_URL}`, {
                    headers: { 'X-Master-Key': API_KEY }
                });

                if (!searchResponse.ok) {
                    throw new Error('Failed to search for rooms');
                }

                const bins = await searchResponse.json();
                
                let foundBin = null;
                if (bins.record && Array.isArray(bins.record)) {
                    foundBin = bins.record.find(bin => bin.name === `room_${code}`);
                }

                if (!foundBin) {
                    try {
                        const directResponse = await fetch(`${BASE_URL}/room_${code}`, {
                            headers: { 'X-Master-Key': API_KEY }
                        });
                        
                        if (directResponse.ok) {
                            const roomData = await directResponse.json();
                            roomBinId = roomData.metadata.id;
                        } else {
                            throw new Error('Room not found');
                        }
                    } catch (directError) {
                        throw new Error('Room not found');
                    }
                } else {
                    roomBinId = foundBin.id;
                }

                const roomResponse = await fetch(`${BASE_URL}/${roomBinId}`, {
                    headers: { 'X-Master-Key': API_KEY }
                });

                if (!roomResponse.ok) {
                    throw new Error('Room no longer exists');
                }

                const roomData = await roomResponse.json();

                roomCode = code;
                isHost = false;
                localPlayer = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    name: name, 
                    money: 10000, 
                    isHost: false 
                };

                roomData.record.players.push(localPlayer);
                await updateRoom(roomData.record);

                document.getElementById('lobby').classList.add('hidden');
                startPolling();
                updateStatus(`Joined room ${code}`, 'connected');
                enableChat();

            } catch (error) {
                console.error('Error joining room:', error);
                
                // Fallback to localStorage
                const roomData = JSON.parse(localStorage.getItem(`room_${code}`) || 'null');
                if (!roomData) {
                    alert('Room not found! Check the code or make sure host created the room.');
                    return;
                }

                roomCode = code;
                roomBinId = `local_${code}`;
                isHost = false;
                localPlayer = { 
                    id: Math.random().toString(36).substr(2, 9), 
                    name: name, 
                    money: 10000, 
                    isHost: false 
                };

                roomData.players.push(localPlayer);
                localStorage.setItem(`room_${code}`, JSON.stringify(roomData));

                document.getElementById('lobby').classList.add('hidden');
                startPolling();
                updateStatus(`Joined room ${code} (local fallback)`, 'connected');
                enableChat();
            }
        }

        async function updateRoom(roomData) {
            try {
                await fetch(`${BASE_URL}/${roomBinId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(roomData)
                });
            } catch (error) {
                console.error('Error updating room:', error);
            }
        }

        function startPolling() {
            pollInterval = setInterval(async () => {
                await pollRoomUpdates();
            }, 2000);
        }

        async function pollRoomUpdates() {
            if (!roomBinId) return;

            try {
                let roomData;
                
                if (USE_LOCAL_STORAGE || roomBinId.startsWith('local_')) {
                    // Use localStorage
                    const stored = localStorage.getItem(`room_${roomCode}`);
                    if (!stored) {
                        updateStatus('Room no longer exists', 'error');
                        return;
                    }
                    roomData = JSON.parse(stored);
                } else {
                    // Use JSONBin.io API
                    const response = await fetch(`${BASE_URL}/${roomBinId}`, {
                        headers: { 'X-Master-Key': API_KEY }
                    });

                    if (!response.ok) {
                        updateStatus('Room no longer exists', 'error');
                        return;
                    }

                    const data = await response.json();
                    roomData = data.record;
                }

                // Update state
                players = roomData.players || [];
                gameState = roomData.gameState || 'lobby';
                currentBid = roomData.currentBid || 0;
                currentBidder = roomData.currentBidder;
                artworks = roomData.artworks || [];

                updatePlayers();
                updateGameUI();
                updateBidDisplay();

                // Handle new messages
                if (roomData.messages && roomData.messages.length > lastMessageCount) {
                    const newMessages = roomData.messages.slice(lastMessageCount);
                    newMessages.forEach(msg => {
                        if (msg.from !== localPlayer.id) {
                            handleMessage(msg);
                        }
                    });
                    lastMessageCount = roomData.messages.length;
                }

                // Handle game state changes
                if (gameState === 'drawing' && !gameTimer) {
                    startDrawing();
                } else if (gameState === 'bidding' && !auctionTimer) {
                    showBidding();
                }

            } catch (error) {
                console.error('Error polling room:', error);
            }
        }

        async function sendMessage(type, data) {
            if (!roomBinId) return;

            try {
                const response = await fetch(`${BASE_URL}/${roomBinId}`, {
                    headers: { 'X-Master-Key': API_KEY }
                });

                if (!response.ok) return;

                const roomData = await response.json();
                
                const message = {
                    id: Math.random().toString(36).substr(2, 9),
                    type: type,
                    data: data,
                    from: localPlayer.id,
                    timestamp: Date.now()
                };

                roomData.record.messages = roomData.record.messages || [];
                roomData.record.messages.push(message);

                // Update synchronized state based on message type
                if (type === 'bid') {
                    roomData.record.currentBid = data.amount;
                    roomData.record.currentBidder = localPlayer.id;
                }

                if (roomData.record.messages.length > 50) {
                    roomData.record.messages = roomData.record.messages.slice(-50);
                }

                await updateRoom(roomData.record);

            } catch (error) {
                console.error('Error sending message:', error);
            }
        }

        function handleMessage(msg) {
            const msgId = msg.timestamp + '_' + msg.from;
            if (processedMessages.has(msgId)) return;
            processedMessages.add(msgId);

            switch (msg.type) {
                case 'chat':
                    addChatMessage(msg.data.content, msg.data.sender);
                    break;
                case 'gameStart':
                    if (!gameTimer) startDrawing();
                    break;
            }
        }

        // Game functions
        async function startGame() {
            if (players.length < 2) return;
            
            try {
                const response = await fetch(`${BASE_URL}/${roomBinId}`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const roomData = await response.json();
                
                roomData.record.gameState = 'drawing';
                await updateRoom(roomData.record);
                
                await sendMessage('gameStart', {});
                startDrawing();
                
            } catch (error) {
                console.error('Error starting game:', error);
            }
        }

        function startDrawing() {
            gameState = 'drawing';
            document.getElementById('lobby').classList.add('hidden');
            document.getElementById('submitBtn').disabled = false;
            timeLeft = 90;
            updateTimer();
            
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = setInterval(() => {
                timeLeft--;
                updateTimer();
                if (timeLeft <= 0) submit();
            }, 1000);
        }

        async function submit() {
            if (gameTimer) clearInterval(gameTimer);
            gameTimer = null;
            document.getElementById('submitBtn').disabled = true;
            
            const artwork = {
                playerId: localPlayer.id,
                playerName: localPlayer.name,
                imageData: canvas.toDataURL(),
                prompt: prompts[Math.floor(Math.random() * prompts.length)]
            };
            
            try {
                const response = await fetch(`${BASE_URL}/${roomBinId}`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const roomData = await response.json();
                
                roomData.record.artworks = roomData.record.artworks || [];
                roomData.record.artworks.push(artwork);
                
                await updateRoom(roomData.record);
                updateStatus('Waiting for others...', 'connected');
                
                // Auto-start auction after delay if host
                setTimeout(async () => {
                    if (isHost) {
                        roomData.record.gameState = 'bidding';
                        await updateRoom(roomData.record);
                    }
                }, 3000);
                
            } catch (error) {
                console.error('Error submitting artwork:', error);
            }
        }

        function showBidding() {
            if (artworks.length === 0) return;
            
            gameState = 'bidding';
            const artwork = artworks[0];
            document.getElementById('bidModal').classList.add('active');
            
            const canvas = document.getElementById('bidArtwork');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
            };
            img.src = artwork.imageData;
            
            updateBidDisplay();
            
            // Auction timer
            timeLeft = 30;
            if (auctionTimer) clearInterval(auctionTimer);
            auctionTimer = setInterval(() => {
                timeLeft--;
                document.getElementById('bidTimer').textContent = `Time: ${timeLeft}s`;
                if (timeLeft <= 0) endAuction();
            }, 1000);
        }

        async function placeBid() {
            const amount = parseInt(document.getElementById('bidInput').value);
            if (!amount || amount <= currentBid || amount > localPlayer.money) {
                alert('Invalid bid amount!');
                return;
            }
            
            await sendMessage('bid', { amount: amount });
            document.getElementById('bidInput').value = amount + 100;
        }

        function updateBidDisplay() {
            const bidderName = currentBidder ? players.find(p => p.id === currentBidder)?.name : 'None';
            document.getElementById('currentBid').textContent = `Current Bid: $${currentBid} (${bidderName})`;
        }

        async function endAuction() {
            if (auctionTimer) clearInterval(auctionTimer);
            auctionTimer = null;
            
            if (currentBidder && isHost) {
                try {
                    const response = await fetch(`${BASE_URL}/${roomBinId}`, {
                        headers: { 'X-Master-Key': API_KEY }
                    });
                    const roomData = await response.json();
                    
                    // Update player money
                    roomData.record.players = roomData.record.players.map(p => {
                        if (p.id === currentBidder) p.money -= currentBid;
                        if (p.id === artworks[0].playerId) p.money += currentBid;
                        return p;
                    });
                    
                    await updateRoom(roomData.record);
                    
                } catch (error) {
                    console.error('Error ending auction:', error);
                }
            }
            
            document.getElementById('bidModal').classList.remove('active');
            alert(`Auction ended! Winner: ${currentBidder ? players.find(p => p.id === currentBidder)?.name : 'No bids'}`);
        }

        // Communication
        async function sendChat() {
            const input = document.getElementById('chatInput');
            const msg = input.value.trim();
            if (!msg) return;
            
            addChatMessage(msg, localPlayer.name, true);
            await sendMessage('chat', { content: msg, sender: localPlayer.name });
            input.value = '';
        }

        function addChatMessage(content, sender, own = false) {
            const div = document.createElement('div');
            div.className = `message ${own ? 'own' : ''}`;
            div.innerHTML = `<b>${sender}:</b> ${content}`;
            document.getElementById('chatMsgs').appendChild(div);
            document.getElementById('chatMsgs').scrollTop = 999999;
        }

        function enableChat() {
            document.getElementById('chatInput').disabled = false;
        }

        function backToMenu() {
            if (gameTimer) clearInterval(gameTimer);
            if (auctionTimer) clearInterval(auctionTimer);
            if (pollInterval) clearInterval(pollInterval);
            
            document.querySelectorAll('.panel > div').forEach(d => d.classList.add('hidden'));
            document.getElementById('mainMenu').classList.remove('hidden');
            
            roomCode = '';
            roomBinId = null;
            isHost = false;
            localPlayer = null;
            players = [];
            processedMessages.clear();
            lastMessageCount = 0;
            updateStatus('Ready to play');
        }

        // UI helpers
        function updateStatus(text, type = '') {
            const el = document.getElementById('status');
            el.textContent = text;
            el.className = `status ${type}`;
        }

        function updatePlayers() {
            const html = players.map(p => 
                `<div class="player"><span>${p.name}${p.isHost ? ' (Host)' : ''}</span><span>$${p.money}</span></div>`
            ).join('');
            document.getElementById('players').innerHTML = html;
            document.getElementById('playerList').innerHTML = `<p>${players.length} players connected</p>`;
            document.getElementById('startBtn').style.display = players.length >= 2 ? 'block' : 'none';
        }

        function updateGameUI() {
            if (localPlayer) {
                const myData = players.find(p => p.id === localPlayer.id);
                if (myData) {
                    localPlayer.money = myData.money;
                    document.getElementById('money').textContent = `$${localPlayer.money}`;
                }
            }
        }

        function updateTimer() {
            document.getElementById('timer').textContent = `${Math.floor(timeLeft/60)}:${(timeLeft%60).toString().padStart(2,'0')}`;
        }
    </script>
</body>
</html>
